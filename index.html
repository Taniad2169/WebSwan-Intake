<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The WebSwan Intake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #c3faef;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .banner {
      background: linear-gradient(120deg, #3a7cbd 0%, #b5ebeb 100%);
      color: #fff;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      padding: 40px 0 30px 0;
      margin-bottom: 40px;
      box-shadow: 0 8px 24px 0 rgba(58,124,189,0.28), 0 1.5px 0 #b5ebeb inset;
      border-radius: 0 0 30px 30px;
      transform: perspective(100px) rotateX(7deg);
      letter-spacing: 2px;
      text-shadow: 0 4px 18px #3a7cbd55, 0 0 3px #b5ebeb88;
    }
    .container {
      max-width: 650px;
      background: #fff;
      margin: 0 auto 40px auto;
      border-radius: 20px;
      box-shadow: 0 6px 24px 0 #3a7cbd22;
      padding: 30px 24px;
    }
    .section-title {
      font-size: 1.2rem;
      color: #3a7cbd;
      margin-top: 18px;
      margin-bottom: 10px;
      font-weight: 600;
      text-shadow: 0 1px 0 #b5ebeb33;
    }
    .form-row {
      margin-bottom: 18px;
      display: flex;
      align-items: center;
    }
    label {
      display: block;
      font-size: 1rem;
      margin-bottom: 4px;
      color: #2d6fa3;
      min-width: 130px;
    }
    input[type="file"], input[type="url"], input[type="text"], input[type="email"] {
      padding: 8px;
      border: 1.5px solid #b5ebeb;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      margin-bottom: 5px;
      background: #f8fcfc;
      transition: border-color .2s;
      flex: 1;
    }
    .hidden {
      display: none;
    }
    .search-section {
      margin-bottom: 22px;
      padding-bottom: 8px;
      border-bottom: 1.5px solid #b5ebeb;
    }
    .btn, .save-btn, .save-link-btn {
      background: linear-gradient(90deg, #3a7cbd 0%, #b5ebeb 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 8px #3a7cbd33;
      margin-left: 8px;
      margin-top: 0;
      margin-bottom: 10px;
      transition: background .2s;
      min-width: 80px;
    }
    .save-btn, .save-link-btn {
      padding: 5px 12px;
      font-size: 0.87rem;
      margin-left: 8px;
      min-width: 70px;
    }
    .btn:active, .save-btn:active, .save-link-btn:active {
      background: linear-gradient(90deg, #b5ebeb 0%, #3a7cbd 100%);
    }
    .results {
      margin-top: 20px;
      padding: 16px;
      background: #eafcff;
      border-radius: 12px;
      box-shadow: 0 2px 6px #3a7cbd22;
    }
    .doc-list {
      margin-top: 10px;
      margin-bottom: 8px;
    }
    .doc-item {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .open-doc-btn {
      background: #3a7cbd;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 10px;
      font-weight: 500;
      transition: background .2s;
    }
    .open-doc-btn:hover {
      background: #b5ebeb;
      color: #3a7cbd;
    }
    .delete-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 8px;
      font-weight: 500;
      transition: background .2s;
    }
    .delete-btn:hover {
      background: #c82333;
    }
    .delete-record-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 500;
      transition: background .2s;
    }
    .delete-record-btn:hover {
      background: #c82333;
    }
    .link-list {
      margin-top: 8px;
      margin-bottom: 6px;
      list-style: decimal;
      padding-left: 18px;
    }
    .contact-save-section {
      margin-top: 20px;
      text-align: center;
    }
    .status {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #155724;
    }
    .record-item {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #b5ebeb;
      border-radius: 8px;
      background: #f8fdff;
    }
    @media (max-width: 700px) {
      .container { max-width: 97vw; }
      .banner { font-size: 1.3rem; padding: 25px 0; }
      .form-row { flex-direction: column; align-items: stretch; }
      label, input, button { width: 100%; margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="banner">The WebSwan Intake</div>
  <div class="container">
    <div id="status" class="status">Ready to save data locally</div>

    <form id="intakeForm" autocomplete="off">
      <!-- Contact Info Section - At the top -->
      <div class="section-title">Contact Info for Saving</div>
      <div class="form-row">
        <label for="name">Name</label>
        <input type="text" id="name" placeholder="Enter name">
      </div>
      <div class="form-row">
        <label for="phone">Phone Number</label>
        <input type="text" id="phone" placeholder="Enter phone number">
      </div>
      <div class="form-row">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="Enter email address">
      </div>
      <div class="contact-save-section">
        <button type="button" class="btn" id="saveContactBtn">Save Contact Info</button>
      </div>

      <!-- Document Uploads Section - In the middle -->
      <div class="section-title">Upload Documents (max 5)</div>
      
      <!-- Document 1 -->
      <div class="form-row">
        <label for="doc0">Document 1</label>
        <input type="file" id="doc0" accept=".pdf,.png,.jpeg,.jpg,.txt">
        <button type="button" class="save-btn" id="saveDoc0">Save</button>
      </div>
      
      <!-- Document 2 -->
      <div class="form-row">
        <label for="doc1">Document 2</label>
        <input type="file" id="doc1" accept=".pdf,.png,.jpeg,.jpg,.txt">
        <button type="button" class="save-btn" id="saveDoc1">Save</button>
      </div>
      
      <!-- Document 3 -->
      <div class="form-row">
        <label for="doc2">Document 3</label>
        <input type="file" id="doc2" accept=".pdf,.png,.jpeg,.jpg,.txt">
        <button type="button" class="save-btn" id="saveDoc2">Save</button>
      </div>
      
      <!-- Document 4 -->
      <div class="form-row">
        <label for="doc3">Document 4</label>
        <input type="file" id="doc3" accept=".pdf,.png,.jpeg,.jpg,.txt">
        <button type="button" class="save-btn" id="saveDoc3">Save</button>
      </div>
      
      <!-- Document 5 -->
      <div class="form-row">
        <label for="doc4">Document 5 (Web Analysis Results)</label>
        <input type="file" id="doc4" accept=".pdf,.png,.jpeg,.jpg,.txt">
        <button type="button" class="save-btn" id="saveDoc4">Save</button>
      </div>

      <!-- Links Section - After documents -->
      <div class="section-title">Save Links (max 12)</div>
      
      <!-- Links 1-3 -->
      <div class="form-row">
        <label for="link0">Link 1</label>
        <input type="url" id="link0" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink0">Save</button>
      </div>
      <div class="form-row">
        <label for="link1">Link 2</label>
        <input type="url" id="link1" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink1">Save</button>
      </div>
      <div class="form-row">
        <label for="link2">Link 3</label>
        <input type="url" id="link2" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink2">Save</button>
      </div>
      
      <!-- Links 4-6 -->
      <div class="form-row">
        <label for="link3">Link 4</label>
        <input type="url" id="link3" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink3">Save</button>
      </div>
      <div class="form-row">
        <label for="link4">Link 5</label>
        <input type="url" id="link4" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink4">Save</button>
      </div>
      <div class="form-row">
        <label for="link5">Link 6</label>
        <input type="url" id="link5" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink5">Save</button>
      </div>
      
      <!-- Links 7-9 -->
      <div class="form-row">
        <label for="link6">Link 7</label>
        <input type="url" id="link6" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink6">Save</button>
      </div>
      <div class="form-row">
        <label for="link7">Link 8</label>
        <input type="url" id="link7" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink7">Save</button>
      </div>
      <div class="form-row">
        <label for="link8">Link 9</label>
        <input type="url" id="link8" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink8">Save</button>
      </div>
      
      <!-- Links 10-12 -->
      <div class="form-row">
        <label for="link9">Link 10</label>
        <input type="url" id="link9" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink9">Save</button>
      </div>
      <div class="form-row">
        <label for="link10">Link 11</label>
        <input type="url" id="link10" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink10">Save</button>
      </div>
      <div class="form-row">
        <label for="link11">Link 12</label>
        <input type="url" id="link11" placeholder="https://example.com">
        <button type="button" class="save-link-btn" id="saveLink11">Save</button>
      </div>

      <!-- Search Section - At the bottom -->
      <div class="search-section">
        <div class="section-title">Search Records (Email or Phone Only)</div>
        <div class="form-row">
          <label for="searchPhone">Search by Phone</label>
          <input type="text" id="searchPhone" placeholder="Enter phone number">
        </div>
        <div class="form-row">
          <label for="searchEmail">Search by Email</label>
          <input type="email" id="searchEmail" placeholder="Enter email address">
        </div>
        <div class="form-row">
          <label></label>
          <button type="button" class="btn" id="searchBtn">Search</button>
        </div>
      </div>
    </form>
    <div id="resultsSection" class="results hidden"></div>
  </div>

  <script>
    // Clean local storage solution - no external dependencies
    (function() {
      'use strict';
      
      // Safe data storage
      let allIntakes = [];
      try {
        allIntakes = JSON.parse(localStorage.getItem('websawnIntakes') || '[]');
      } catch (e) {
        allIntakes = [];
      }
      
      function updateStatus(message, isError = false) {
        const status = document.getElementById('status');
        if (status) {
          status.textContent = message;
          status.style.background = isError ? '#f8d7da' : '#d4edda';
          status.style.color = isError ? '#721c24' : '#155724';
          status.style.borderColor = isError ? '#f5c6cb' : '#c3e6cb';
        }
      }

      // Safe DOM ready function
      function domReady(fn) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fn);
        } else {
          fn();
        }
      }

      domReady(function() {
        setupEventListeners();
        updateStatus('Ready! Enter contact info and click Save buttons');
      });

      function setupEventListeners() {
        // Safe element access with null checks
        const elements = {
          saveContactBtn: document.getElementById('saveContactBtn'),
          searchBtn: document.getElementById('searchBtn')
        };

        if (elements.saveContactBtn) {
          elements.saveContactBtn.addEventListener('click', saveContactInfo);
        }
        
        if (elements.searchBtn) {
          elements.searchBtn.addEventListener('click', performSearch);
        }
        
        // Document save buttons
        for (let i = 0; i < 5; i++) {
          const btn = document.getElementById('saveDoc' + i);
          if (btn) {
            btn.addEventListener('click', function() {
              saveDocument(i);
            });
          }
        }
        
        // Link save buttons
        for (let i = 0; i < 12; i++) {
          const btn = document.getElementById('saveLink' + i);
          if (btn) {
            btn.addEventListener('click', function() {
              saveLink(i);
            });
          }
        }
      }

      function generateRecordId() {
        const name = getValue('name');
        const phone = getValue('phone');
        const email = getValue('email');
        
        let parts = [];
        if (name) parts.push(name.replace(/[^a-zA-Z0-9]/g, '_'));
        if (phone) parts.push(phone.replace(/\D/g, ''));
        if (email) parts.push(email.replace(/[^a-zA-Z0-9@.]/g, '_'));
        
        if (parts.length === 0) return null;
        return parts.join('_') + '_' + Math.random().toString(36).substr(2, 9);
      }

      function getValue(id) {
        const element = document.getElementById(id);
        return element ? element.value.trim() : '';
      }

      function saveContactInfo() {
        const name = getValue('name');
        const phone = getValue('phone');
        const email = getValue('email');
        
        if (!name && !phone && !email) {
          updateStatus('❌ Please enter at least one contact field (name, phone, or email)', true);
          return;
        }
        
        const recordId = generateRecordId();
        if (!recordId) {
          updateStatus('❌ Could not generate record ID', true);
          return;
        }
        
        // Find existing record or create new one
        let record = allIntakes.find(r => r.id === recordId);
        if (!record) {
          record = {
            id: recordId,
            name: name || null,
            phone: phone || null,
            email: email || null,
            files: [],
            links: [],
            createdAt: new Date().toISOString()
          };
          allIntakes.push(record);
        } else {
          // Update existing record
          record.name = name || null;
          record.phone = phone || null;
          record.email = email || null;
          record.lastUpdated = new Date().toISOString();
        }
        
        // Safe localStorage save
        try {
          localStorage.setItem('websawnIntakes', JSON.stringify(allIntakes));
          updateStatus('✅ Contact info saved successfully!');
        } catch (e) {
          updateStatus('❌ Storage error: Could not save data', true);
        }
      }

      function saveDocument(index) {
        const name = getValue('name');
        const phone = getValue('phone');
        const email = getValue('email');
        
        if (!name && !phone && !email) {
          updateStatus('❌ Please enter contact info first', true);
          return;
        }
        
        const fileInput = document.getElementById('doc' + index);
        if (!fileInput || fileInput.files.length === 0) {
          updateStatus('❌ Please select a file to save', true);
          return;
        }
        
        const file = fileInput.files[0];
        
        // Validate file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
          updateStatus('❌ File size too large. Maximum size is 10MB', true);
          return;
        }
        
        const recordId = generateRecordId();
        if (!recordId) {
          updateStatus('❌ Could not generate record ID', true);
          return;
        }
        
        // Find existing record or create new one
        let record = allIntakes.find(r => r.id === recordId);
        if (!record) {
          record = {
            id: recordId,
            name: name || null,
            phone: phone || null,
            email: email || null,
            files: [],
            links: [],
            createdAt: new Date().toISOString()
          };
          allIntakes.push(record);
        }
        
        // Convert file to base64 for local storage
        const reader = new FileReader();
        reader.onload = function(e) {
          record.files[index] = {
            name: file.name,
            type: file.type,
            data: e.target.result,
            size: file.size,
            uploadedAt: new Date().toISOString()
          };
          
          try {
            localStorage.setItem('websawnIntakes', JSON.stringify(allIntakes));
            updateStatus('✅ File saved successfully!');
            fileInput.value = "";
          } catch (e) {
            updateStatus('❌ Storage error: Could not save file', true);
          }
        };
        
        reader.onerror = function() {
          updateStatus('❌ Error reading file', true);
        };
        
        reader.readAsDataURL(file);
      }

      function saveLink(index) {
        const name = getValue('name');
        const phone = getValue('phone');
        const email = getValue('email');
        
        if (!name && !phone && !email) {
          updateStatus('❌ Please enter contact info first', true);
          return;
        }
        
        const linkInput = document.getElementById('link' + index);
        const linkVal = linkInput ? linkInput.value.trim() : '';
        if (!linkVal) {
          updateStatus('❌ Please enter a link to save', true);
          return;
        }
        
        // Basic URL validation
        try {
          new URL(linkVal);
        } catch (e) {
          updateStatus('❌ Please enter a valid URL (include http:// or https://)', true);
          return;
        }
        
        const recordId = generateRecordId();
        if (!recordId) {
          updateStatus('❌ Could not generate record ID', true);
          return;
        }
        
        // Find existing record or create new one
        let record = allIntakes.find(r => r.id === recordId);
        if (!record) {
          record = {
            id: recordId,
            name: name || null,
            phone: phone || null,
            email: email || null,
            files: [],
            links: [],
            createdAt: new Date().toISOString()
          };
          allIntakes.push(record);
        }
        
        record.links[index] = linkVal;
        
        try {
          localStorage.setItem('websawnIntakes', JSON.stringify(allIntakes));
          updateStatus('✅ Link saved successfully!');
          if (linkInput) linkInput.value = "";
        } catch (e) {
          updateStatus('❌ Storage error: Could not save link', true);
        }
      }

      function performSearch() {
        const searchPhone = getValue('searchPhone');
        const searchEmail = getValue('searchEmail');

        if (!searchPhone && !searchEmail) {
          updateStatus('❌ Please enter either phone number or email to search', true);
          return;
        }

        const resultsSection = document.getElementById('resultsSection');
        if (!resultsSection) return;

        resultsSection.innerHTML = "🔍 Searching...";
        resultsSection.classList.remove('hidden');

        // Filter records based on search criteria (phone OR email only)
        const filteredRecords = allIntakes.filter(record => {
          if (searchPhone && record.phone === searchPhone) return true;
          if (searchEmail && record.email === searchEmail) return true;
          return false;
        });

        if (filteredRecords.length === 0) {
          resultsSection.innerHTML = '<span style="color:#f00;">❌ No records found for this search criteria.</span>';
          updateStatus('No records found for search criteria');
          return;
        }

        let html = '';
        filteredRecords.forEach(record => {
          html += `<div class="record-item">`;
          html += `<b>Name:</b> ${record.name || 'N/A'}<br>`;
          html += `<b>Phone:</b> ${record.phone || 'N/A'}<br>`;
          html += `<b>Email:</b> ${record.email || 'N/A'}<br>`;
          html += `<div class="doc-list"><b>Documents:</b><br>`;
          
          if (record.files && record.files.length) {
            record.files.forEach((file, idx) => {
              if (file) {
                // Escape data for security
                const safeData = file.data.replace(/'/g, "\\'");
                html += `<div class="doc-item">
                  <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                  <div>
                    <button class="open-doc-btn" onclick="window.webSwanOpenDocument('${safeData}')">Open</button>
                    <button class="delete-btn" onclick="window.webSwanDeleteDocument('${record.id}', ${idx})">Delete</button>
                    ${idx === 4 ? '<span style="color:#3a7cbd;font-weight:600;">(Web Analysis Results)</span>' : ''}
                  </div>
                </div>`;
              }
            });
          } else {
            html += `<div style="color:#999;">No documents uploaded yet.</div>`;
          }
          
          html += `</div>`;
          html += `<div><b>Links:</b>`;
          if (record.links && record.links.filter(l => l).length > 0) {
            html += `<ol class="link-list">
              ${record.links.filter(l => l).map(l => `<li><a href="${l}" target="_blank" rel="noopener">${l}</a></li>`).join('')}
            </ol>`;
          } else {
            html += `<div style="color:#999;margin-top:5px;">No links saved yet.</div>`;
          }
          html += `</div>`;
          html += `<button class="delete-record-btn" onclick="window.webSwanDeleteRecord('${record.id}')">Delete Entire Record</button>`;
          html += `</div>`;
        });
        
        resultsSection.innerHTML = html;
        updateStatus(`Found ${filteredRecords.length} record(s)`);
      }

      // Global functions for onclick handlers
      window.webSwanOpenDocument = function(base64Data) {
        const newWindow = window.open();
        if (newWindow) {
          newWindow.document.write(`
            <html>
              <head><title>Document Viewer</title></head>
              <body style="margin: 0; padding: 20px;">
                <iframe src="${base64Data}" style="width: 100%; height: 100vh; border: none;"></iframe>
              </body>
            </html>
          `);
        }
      };

      window.webSwanDeleteDocument = function(recordId, documentIndex) {
        if (!confirm('Are you sure you want to delete this document?')) {
          return;
        }
        
        const record = allIntakes.find(r => r.id === recordId);
        if (record && record.files && record.files[documentIndex]) {
          record.files[documentIndex] = null;
          try {
            localStorage.setItem('websawnIntakes', JSON.stringify(allIntakes));
            updateStatus('✅ Document deleted successfully!');
            performSearch();
          } catch (e) {
            updateStatus('❌ Storage error: Could not delete document', true);
          }
        }
      };

      window.webSwanDeleteRecord = function(recordId) {
        if (!confirm('Are you sure you want to delete this entire record? This cannot be undone!')) {
          return;
        }
        
        allIntakes = allIntakes.filter(r => r.id !== recordId);
        try {
          localStorage.setItem('websawnIntakes', JSON.stringify(allIntakes));
          updateStatus('✅ Record deleted successfully!');
          performSearch();
        } catch (e) {
          updateStatus('❌ Storage error: Could not delete record', true);
        }
      };
    })();
  </script>
</body>
</html>